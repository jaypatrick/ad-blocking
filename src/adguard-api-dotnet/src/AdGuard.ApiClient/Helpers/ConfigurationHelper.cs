/*
 * AdGuard DNS API
 *
 * DNS API documentation
 *
 * The version of the OpenAPI document: 1.11
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

using System;
using System.Collections.Generic;
using AdGuard.ApiClient.Client;
using Microsoft.Extensions.Logging;

namespace AdGuard.ApiClient.Helpers
{
    /// <summary>
    /// Helper class for configuring AdGuard DNS API client.
    /// Provides factory methods and extension methods for creating and customizing Configuration instances.
    /// </summary>
    /// <remarks>
    /// This class provides a fluent API for building configuration objects with various authentication methods
    /// and custom settings. It supports both API Key and Bearer Token authentication.
    /// </remarks>
    /// <example>
    /// Creating a configuration with API Key:
    /// <code>
    /// var config = ConfigurationHelper.CreateWithApiKey("your-api-key");
    /// </code>
    ///
    /// Using fluent API:
    /// <code>
    /// var config = ConfigurationHelper.CreateCustom()
    ///     .WithApiKey("your-api-key")
    ///     .WithTimeout(30000)
    ///     .WithUserAgent("MyApp/1.0");
    /// </code>
    /// </example>
    public static class ConfigurationHelper
    {
        /// <summary>
        /// The default base path for the AdGuard DNS API.
        /// </summary>
        private const string DefaultBasePath = "https://api.adguard-dns.io";

        /// <summary>
        /// Default timeout in milliseconds (30 seconds).
        /// </summary>
        private const int DefaultTimeoutMilliseconds = 30000;

        /// <summary>
        /// Minimum allowed timeout in milliseconds (1 second).
        /// </summary>
        private const int MinTimeoutMilliseconds = 1000;

        /// <summary>
        /// Maximum allowed timeout in milliseconds (5 minutes).
        /// </summary>
        private const int MaxTimeoutMilliseconds = 300000;

        /// <summary>
        /// Creates a configuration with API Key authentication.
        /// </summary>
        /// <param name="apiKey">Your AdGuard DNS API key. Must not be null or empty.</param>
        /// <param name="basePath">Optional base path. Defaults to https://api.adguard-dns.io if not specified.</param>
        /// <param name="logger">Optional logger for diagnostic output.</param>
        /// <returns>A configured <see cref="Configuration"/> instance ready for use with API clients.</returns>
        /// <exception cref="ArgumentException">Thrown when <paramref name="apiKey"/> is null, empty, or whitespace.</exception>
        /// <exception cref="ArgumentException">Thrown when <paramref name="basePath"/> is invalid (if provided).</exception>
        /// <example>
        /// <code>
        /// var config = ConfigurationHelper.CreateWithApiKey("your-api-key");
        /// var accountApi = new AccountApi(config);
        /// </code>
        /// </example>
        public static Configuration CreateWithApiKey(string apiKey, string? basePath = null, ILogger? logger = null)
        {
            if (string.IsNullOrWhiteSpace(apiKey))
            {
                logger?.LogError("API key validation failed: API key is null, empty, or whitespace");
                throw new ArgumentException("API key cannot be null, empty, or whitespace.", nameof(apiKey));
            }

            if (basePath != null && !Uri.TryCreate(basePath, UriKind.Absolute, out var uri))
            {
                logger?.LogError("Base path validation failed: '{BasePath}' is not a valid URI", basePath);
                throw new ArgumentException($"Base path '{basePath}' is not a valid URI.", nameof(basePath));
            }

            var effectiveBasePath = basePath ?? DefaultBasePath;
            logger?.LogDebug("Creating configuration with API Key authentication. BasePath: {BasePath}", effectiveBasePath);

            var config = new Configuration
            {
                BasePath = effectiveBasePath,
                ApiKey = new Dictionary<string, string>
                {
                    { "Authorization", $"ApiKey {apiKey}" }
                }
            };

            logger?.LogInformation("Configuration created successfully with API Key authentication");
            return config;
        }

        /// <summary>
        /// Creates a configuration with Bearer token authentication (OAuth).
        /// </summary>
        /// <param name="accessToken">Your OAuth access token. Must not be null or empty.</param>
        /// <param name="basePath">Optional base path. Defaults to https://api.adguard-dns.io if not specified.</param>
        /// <param name="logger">Optional logger for diagnostic output.</param>
        /// <returns>A configured <see cref="Configuration"/> instance ready for use with API clients.</returns>
        /// <exception cref="ArgumentException">Thrown when <paramref name="accessToken"/> is null, empty, or whitespace.</exception>
        /// <exception cref="ArgumentException">Thrown when <paramref name="basePath"/> is invalid (if provided).</exception>
        /// <example>
        /// <code>
        /// var config = ConfigurationHelper.CreateWithBearerToken("your-oauth-token");
        /// var accountApi = new AccountApi(config);
        /// </code>
        /// </example>
        public static Configuration CreateWithBearerToken(string accessToken, string? basePath = null, ILogger? logger = null)
        {
            if (string.IsNullOrWhiteSpace(accessToken))
            {
                logger?.LogError("Access token validation failed: Access token is null, empty, or whitespace");
                throw new ArgumentException("Access token cannot be null, empty, or whitespace.", nameof(accessToken));
            }

            if (basePath != null && !Uri.TryCreate(basePath, UriKind.Absolute, out var uri))
            {
                logger?.LogError("Base path validation failed: '{BasePath}' is not a valid URI", basePath);
                throw new ArgumentException($"Base path '{basePath}' is not a valid URI.", nameof(basePath));
            }

            var effectiveBasePath = basePath ?? DefaultBasePath;
            logger?.LogDebug("Creating configuration with Bearer token authentication. BasePath: {BasePath}", effectiveBasePath);

            var config = new Configuration
            {
                BasePath = effectiveBasePath,
                AccessToken = accessToken
            };

            logger?.LogInformation("Configuration created successfully with Bearer token authentication");
            return config;
        }

        /// <summary>
        /// Creates a configuration with custom settings without authentication.
        /// </summary>
        /// <remarks>
        /// Use this method when you need to configure authentication separately using extension methods
        /// like <see>
        ///     <cref>WithApiKey</cref>
        /// </see>
        /// or <see cref="WithBearerToken"/>.
        /// </remarks>
        /// <param name="basePath">API base path. Defaults to https://api.adguard-dns.io if not specified.</param>
        /// <param name="timeout">Optional timeout in milliseconds. Must be between 1000 and 300000 if specified.</param>
        /// <param name="userAgent">Optional custom user agent string.</param>
        /// <param name="logger">Optional logger for diagnostic output.</param>
        /// <returns>A configured <see cref="Configuration"/> instance.</returns>
        /// <exception cref="ArgumentException">Thrown when <paramref name="basePath"/> is invalid.</exception>
        /// <exception cref="ArgumentOutOfRangeException">Thrown when <paramref name="timeout"/> is outside valid range.</exception>
        /// <exception cref="ArgumentException">Thrown when <paramref name="userAgent"/> is empty or whitespace (if provided).</exception>
        /// <example>
        /// <code>
        /// var config = ConfigurationHelper.CreateCustom(timeout: 60000, userAgent: "MyApp/1.0")
        ///     .WithApiKey("your-api-key");
        /// </code>
        /// </example>
        public static Configuration CreateCustom(string? basePath = null, int? timeout = null, string? userAgent = null, ILogger? logger = null)
        {
            if (basePath != null && !Uri.TryCreate(basePath, UriKind.Absolute, out var uri))
            {
                logger?.LogError("Base path validation failed: '{BasePath}' is not a valid URI", basePath);
                throw new ArgumentException($"Base path '{basePath}' is not a valid URI.", nameof(basePath));
            }

            if (timeout.HasValue && (timeout.Value < MinTimeoutMilliseconds || timeout.Value > MaxTimeoutMilliseconds))
            {
                logger?.LogError("Timeout validation failed: {Timeout}ms is outside valid range ({Min}ms - {Max}ms)",
                    timeout.Value, MinTimeoutMilliseconds, MaxTimeoutMilliseconds);
                throw new ArgumentOutOfRangeException(nameof(timeout),
                    $"Timeout must be between {MinTimeoutMilliseconds}ms and {MaxTimeoutMilliseconds}ms. Value: {timeout.Value}ms");
            }

            if (userAgent != null && string.IsNullOrWhiteSpace(userAgent))
            {
                logger?.LogError("User agent validation failed: User agent cannot be empty or whitespace");
                throw new ArgumentException("User agent cannot be empty or whitespace when provided.", nameof(userAgent));
            }

            var effectiveBasePath = basePath ?? DefaultBasePath;
            logger?.LogDebug("Creating custom configuration. BasePath: {BasePath}, Timeout: {Timeout}ms, UserAgent: {UserAgent}",
                effectiveBasePath, timeout ?? DefaultTimeoutMilliseconds, userAgent ?? "default");

            var config = new Configuration
            {
                BasePath = effectiveBasePath
            };

            if (timeout.HasValue)
            {
                config.Timeout = TimeSpan.FromMilliseconds(timeout.Value);
                logger?.LogDebug("Timeout set to {Timeout}ms", timeout.Value);
            }

            if (!string.IsNullOrWhiteSpace(userAgent))
            {
                config.UserAgent = userAgent;
                logger?.LogDebug("User agent set to '{UserAgent}'", userAgent);
            }

            logger?.LogInformation("Custom configuration created successfully");
            return config;
        }

        /// <summary>
        /// Adds API Key authentication to an existing configuration.
        /// </summary>
        /// <param name="configuration">The configuration to modify. Must not be null.</param>
        /// <param name="apiKey">API key to add. Must not be null, empty, or whitespace.</param>
        /// <returns>The modified configuration for method chaining.</returns>
        /// <exception cref="ArgumentNullException">Thrown when <paramref name="configuration"/> is null.</exception>
        /// <exception cref="ArgumentException">Thrown when <paramref name="apiKey"/> is null, empty, or whitespace.</exception>
        /// <example>
        /// <code>
        /// var config = new Configuration().WithApiKey("your-api-key");
        /// </code>
        /// </example>
        public static Configuration WithApiKey(this Configuration configuration, string apiKey)
        {
            return WithApiKey(configuration, apiKey, null);
        }

        /// <summary>
        /// Adds API key authentication to the specified configuration instance.
        /// </summary>
        /// <remarks>This method sets the "Authorization" header in the configuration's API key dictionary
        /// to use the provided API key. Subsequent requests using this configuration will include the API key for
        /// authentication.</remarks>
        /// <param name="configuration"></param>
        /// <param name="apiKey"></param>
        /// <param name="logger"></param>
        /// <returns></returns>
        /// <exception cref="ArgumentNullException"></exception>
        /// <exception cref="ArgumentException"></exception>
        public static Configuration WithApiKey(this Configuration configuration, string apiKey, ILogger? logger = null)
        {
            if (configuration == null)
            {
                logger?.LogError("Configuration is null");
                throw new ArgumentNullException(nameof(configuration), "Configuration cannot be null.");
            }

            if (string.IsNullOrWhiteSpace(apiKey))
            {
                logger?.LogError("API key validation failed: API key is null, empty, or whitespace");
                throw new ArgumentException("API key cannot be null, empty, or whitespace.", nameof(apiKey));
            }

            logger?.LogDebug("Adding API Key authentication to configuration");

            configuration.ApiKey ??= new Dictionary<string, string>();
            configuration.ApiKey["Authorization"] = $"ApiKey {apiKey}";

            logger?.LogInformation("API Key authentication added successfully");
            return configuration;
        }

        /// <summary>
        /// Adds Bearer token authentication to an existing configuration.
        /// </summary>
        /// <param name="configuration">The configuration to modify. Must not be null.</param>
        /// <param name="accessToken">Access token to add. Must not be null, empty, or whitespace.</param>
        /// <param name="logger">Optional logger for diagnostic output.</param>
        /// <returns>The modified configuration for method chaining.</returns>
        /// <exception cref="ArgumentNullException">Thrown when <paramref name="configuration"/> is null.</exception>
        /// <exception cref="ArgumentException">Thrown when <paramref name="accessToken"/> is null, empty, or whitespace.</exception>
        /// <example>
        /// <code>
        /// var config = new Configuration().WithBearerToken("your-oauth-token");
        /// </code>
        /// </example>
        public static Configuration WithBearerToken(this Configuration configuration, string accessToken, ILogger? logger = null)
        {
            if (configuration == null)
            {
                logger?.LogError("Configuration is null");
                throw new ArgumentNullException(nameof(configuration), "Configuration cannot be null.");
            }

            if (string.IsNullOrWhiteSpace(accessToken))
            {
                logger?.LogError("Access token validation failed: Access token is null, empty, or whitespace");
                throw new ArgumentException("Access token cannot be null, empty, or whitespace.", nameof(accessToken));
            }

            logger?.LogDebug("Adding Bearer token authentication to configuration");

            configuration.AccessToken = accessToken;

            logger?.LogInformation("Bearer token authentication added successfully");
            return configuration;
        }

        /// <summary>
        /// Sets the timeout for the configuration.
        /// </summary>
        /// <param name="configuration">The configuration to modify. Must not be null.</param>
        /// <param name="timeoutMilliseconds">Timeout in milliseconds. Must be between 1000 and 300000.</param>
        /// <param name="logger">Optional logger for diagnostic output.</param>
        /// <returns>The modified configuration for method chaining.</returns>
        /// <exception cref="ArgumentNullException">Thrown when <paramref name="configuration"/> is null.</exception>
        /// <exception cref="ArgumentOutOfRangeException">Thrown when <paramref name="timeoutMilliseconds"/> is outside valid range.</exception>
        /// <example>
        /// <code>
        /// var config = new Configuration().WithTimeout(60000); // 60 seconds
        /// </code>
        /// </example>
        public static Configuration WithTimeout(this Configuration configuration, int timeoutMilliseconds, ILogger? logger = null)
        {
            if (configuration == null)
            {
                logger?.LogError("Configuration is null");
                throw new ArgumentNullException(nameof(configuration), "Configuration cannot be null.");
            }

            if (timeoutMilliseconds < MinTimeoutMilliseconds || timeoutMilliseconds > MaxTimeoutMilliseconds)
            {
                logger?.LogError("Timeout validation failed: {Timeout}ms is outside valid range ({Min}ms - {Max}ms)",
                    timeoutMilliseconds, MinTimeoutMilliseconds, MaxTimeoutMilliseconds);
                throw new ArgumentOutOfRangeException(nameof(timeoutMilliseconds),
                    $"Timeout must be between {MinTimeoutMilliseconds}ms and {MaxTimeoutMilliseconds}ms. Value: {timeoutMilliseconds}ms");
            }

            logger?.LogDebug("Setting timeout to {Timeout}ms", timeoutMilliseconds);

            configuration.Timeout = TimeSpan.FromMilliseconds(timeoutMilliseconds);

            logger?.LogInformation("Timeout set successfully to {Timeout}ms", timeoutMilliseconds);
            return configuration;
        }

        /// <summary>
        /// Sets a custom user agent for the configuration.
        /// </summary>
        /// <param name="configuration">The configuration to modify. Must not be null.</param>
        /// <param name="userAgent">User agent string. Must not be null, empty, or whitespace.</param>
        /// <param name="logger">Optional logger for diagnostic output.</param>
        /// <returns>The modified configuration for method chaining.</returns>
        /// <exception cref="ArgumentNullException">Thrown when <paramref name="configuration"/> is null.</exception>
        /// <exception cref="ArgumentException">Thrown when <paramref name="userAgent"/> is null, empty, or whitespace.</exception>
        /// <example>
        /// <code>
        /// var config = new Configuration().WithUserAgent("MyApp/1.0");
        /// </code>
        /// </example>
        public static Configuration WithUserAgent(this Configuration configuration, string userAgent, ILogger? logger = null)
        {
            if (configuration == null)
            {
                logger?.LogError("Configuration is null");
                throw new ArgumentNullException(nameof(configuration), "Configuration cannot be null.");
            }

            if (string.IsNullOrWhiteSpace(userAgent))
            {
                logger?.LogError("User agent validation failed: User agent is null, empty, or whitespace");
                throw new ArgumentException("User agent cannot be null, empty, or whitespace.", nameof(userAgent));
            }

            logger?.LogDebug("Setting user agent to '{UserAgent}'", userAgent);

            configuration.UserAgent = userAgent;

            logger?.LogInformation("User agent set successfully");
            return configuration;
        }

        /// <summary>
        /// Validates that a configuration has proper authentication set up.
        /// </summary>
        /// <param name="configuration">The configuration to validate. Must not be null.</param>
        /// <param name="logger">Optional logger for diagnostic output.</param>
        /// <returns>True if the configuration has valid authentication; otherwise, false.</returns>
        /// <exception cref="ArgumentNullException">Thrown when <paramref name="configuration"/> is null.</exception>
        /// <example>
        /// <code>
        /// var config = ConfigurationHelper.CreateWithApiKey("your-api-key");
        /// bool isValid = ConfigurationHelper.ValidateAuthentication(config);
        /// </code>
        /// </example>
        public static bool ValidateAuthentication(Configuration configuration, ILogger? logger = null)
        {
            if (configuration == null)
            {
                logger?.LogError("Configuration is null");
                throw new ArgumentNullException(nameof(configuration), "Configuration cannot be null.");
            }

            logger?.LogDebug("Validating configuration authentication");

            var hasApiKey = configuration.ApiKey?.ContainsKey("Authorization") == true &&
                           !string.IsNullOrWhiteSpace(configuration.ApiKey["Authorization"]);
            var hasBearerToken = !string.IsNullOrWhiteSpace(configuration.AccessToken);

            if (hasApiKey)
            {
                logger?.LogDebug("Configuration has valid API Key authentication");
                return true;
            }

            if (hasBearerToken)
            {
                logger?.LogDebug("Configuration has valid Bearer token authentication");
                return true;
            }

            logger?.LogWarning("Configuration does not have valid authentication");
            return false;
        }
    }
}
